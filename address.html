<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Delivery Addresses</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">
  <div class="max-w-2xl mx-auto my-10 p-6 bg-white shadow-xl rounded-2xl">
    <h2 class="text-2xl font-bold mb-6 text-center">Delivery Addresses</h2>
    
    <!-- Add/Edit Address Form -->
    <form id="address-form" class="space-y-4 mb-8">
      <input type="hidden" id="address-id" />
      <div>
        <label class="block text-sm font-medium mb-1" for="address-line">Address Line</label>
        <input id="address-line" type="text" class="w-full border rounded px-3 py-2" required />
      </div>
      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="city">City</label>
          <input id="city" type="text" class="w-full border rounded px-3 py-2" required />
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="state">State</label>
          <input id="state" type="text" class="w-full border rounded px-3 py-2" required />
        </div>
      </div>
      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="zip">Zip Code</label>
          <input id="zip" type="text" class="w-full border rounded px-3 py-2" required />
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="country">Country</label>
          <input id="country" type="text" class="w-full border rounded px-3 py-2" required />
        </div>
      </div>
      <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700 transition w-full" id="submit-btn">
        Add Address
      </button>
      <button type="button" class="hidden bg-gray-400 text-white px-5 py-2 rounded hover:bg-gray-500 transition w-full mt-2" id="cancel-btn">
        Cancel Edit
      </button>
    </form>

    <!-- Address List -->
    <div>
      <h3 class="text-lg font-semibold mb-3">Saved Addresses</h3>
      <ul id="address-list" class="space-y-4">
        <!-- Addresses will be rendered here -->
      </ul>
    </div>
  </div>
<!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Simulated address data (replace with API calls in production)
    let addresses = [];
    let editingId = null;
    let user;

    axios
      .get(
        "https://payday_api.test/api/v1/projects/e_commerce_app/auth/user?api_key=uNzLCrrBMK8ulWQaJvAvYgw4",
        {
          headers: {
            Authorization: "Bearer " + sessionStorage.getItem("token"),
          },
        }
      )
      .then((response) => {
        user = response.data.data;
        
                // Fetch addresses from the API
        axios.get('https://payday_api.test/api/v1/projects/e_commerce_app/tables/delivery_addresses/records?api_key=uNzLCrrBMK8ulWQaJvAvYgw4',{
            headers: {
              Authorization: "Bearer " + sessionStorage.getItem("token"),
            },
        })
          .then(response => {
            addresses = response.data.data;
            renderAddresses();
          })
          .catch(error => {
            console.error('Error fetching addresses:', error);
          });
      })
      .catch((error) => {
        //redirect to login if token is invalid
        if (error.response && error.response.status === 401) {
          alert("Unable to get authenticated user. Please log in again.");
          window.location.href = "login.html";
        }
      });

      window.addEventListener('DOMContentLoaded', () => {

      });

    const addressForm = document.getElementById('address-form');
    const addressList = document.getElementById('address-list');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    // Form fields
    const addressIdInput = document.getElementById('address-id');
    const addressLineInput = document.getElementById('address-line');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const zipInput = document.getElementById('zip');
    const countryInput = document.getElementById('country');

    // Render address list
    function renderAddresses() {
      addressList.innerHTML = '';
      if (addresses.length === 0) {
        addressList.innerHTML = '<li class="text-gray-500 text-center">No addresses saved.</li>';
        return;
      }
      addresses.forEach((addr, idx) => {
        const li = document.createElement('li');
        li.className = "p-4 bg-gray-50 rounded shadow flex flex-col md:flex-row md:items-center md:justify-between gap-2";
        li.innerHTML = `
          <div>
            <div class="font-semibold">${addr.address_line}</div>
            <div class="text-sm text-gray-600">${addr.city}, ${addr.state}, ${addr.zip}, ${addr.country}</div>
          </div>
          <div class="flex gap-2 mt-2 md:mt-0">
            <button class="edit-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded" data-idx="${addr.id}">Edit</button>
            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-idx="${addr.id}">Delete</button>
          </div>
        `;
        addressList.appendChild(li);
      });
      // Attach event listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => startEditAddress(btn.dataset.idx);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => deleteAddress(btn.dataset.idx);
      });
    }

    // Add or update address
    addressForm.onsubmit = function(e) {
      e.preventDefault();
      const address = {
        address_line: addressLineInput.value.trim(),
        city: cityInput.value.trim(),
        state: stateInput.value.trim(),
        zip: zipInput.value.trim(),
        country: countryInput.value.trim()
      };
      if (editingId !== null) {
     
        axios.put('https://payday_api.test/api/v1/projects/e_commerce_app/tables/delivery_addresses/records/' + editingId + '?api_key=uNzLCrrBMK8ulWQaJvAvYgw4', {
          address_line: address.address_line,
          city: address.city,
          state: address.state,
          zip: address.zip,
          country: address.country,
          user_id: user.id
        }).then(response => {
          addresses = addresses.map(i => i.id === editingId ? response.data.data : i);
          addressForm.reset();
          renderAddresses();
        }).catch(error => {
          console.error('Error adding address:', error);
        });
        submitBtn.textContent = "Add Address";
        cancelBtn.classList.add('hidden');
      } else {
        axios.post('https://payday_api.test/api/v1/projects/e_commerce_app/tables/delivery_addresses/records?api_key=uNzLCrrBMK8ulWQaJvAvYgw4', {
          address_line: address.address_line,
          city: address.city,
          state: address.state,
          zip: address.zip,
          country: address.country,
          user_id: user.id
        }).then(response => {
          console.log('Address added:', response.data.data);
          addresses.push(response.data.data);
          addressForm.reset();
          renderAddresses();
        }).catch(error => {
          console.error('Error adding address:', error);
        });
      }
    };

    // Start editing
    function startEditAddress(idx) {
      const addr = addresses.find(i => i.id === idx);
      addressLineInput.value = addr.address_line;
      cityInput.value = addr.city;
      stateInput.value = addr.state;
      zipInput.value = addr.zip;
      countryInput.value = addr.country;
      editingId = idx;
      submitBtn.textContent = "Update Address";
      cancelBtn.classList.remove('hidden');
    }

    // Cancel editing
    cancelBtn.onclick = function() {
      editingId = null;
      addressForm.reset();
      submitBtn.textContent = "Add Address";
      cancelBtn.classList.add('hidden');
    };

    // Delete address
    function deleteAddress(idx) {
      if (confirm("Are you sure you want to delete this address?")) {
        axios.delete('https://payday_api.test/api/v1/projects/e_commerce_app/tables/delivery_addresses/records/' + idx + '?api_key=uNzLCrrBMK8ulWQaJvAvYgw4')
          .then(response => {
        addresses = addresses.filter(i => i.id !== idx);
            renderAddresses();
          })
          .catch(error => {
            console.error('Error deleting address:', error);
          });
        if (editingId === idx) {
          editingId = null;
          addressForm.reset();
          submitBtn.textContent = "Add Address";
          cancelBtn.classList.add('hidden');
        }
      }
    }


  </script>
</body>
</html>